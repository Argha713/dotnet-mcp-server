# Argha - 2026-02-23 - Release workflow: builds self-contained single-file binaries for all platforms on v* tags
name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-binaries:
    name: Build (${{ matrix.rid }})
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
            artifact: dotnet-mcp-server-win-x64.exe
            binary: dotnet-mcp-server.exe
          - os: ubuntu-latest
            rid: linux-x64
            artifact: dotnet-mcp-server-linux-x64
            binary: dotnet-mcp-server
          - os: macos-latest
            rid: osx-arm64
            artifact: dotnet-mcp-server-osx-arm64
            binary: dotnet-mcp-server

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # Argha - 2026-02-23 - run tests on every platform before producing release artifacts
      - name: Test
        run: dotnet test --configuration Release --verbosity normal

      # Argha - 2026-02-23 - strip the leading 'v' from the tag to get a clean semver (e.g. v1.0.0 -> 1.0.0)
      - name: Extract version
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Publish
        run: >
          dotnet publish src/McpServer
          --configuration Release
          --runtime ${{ matrix.rid }}
          --self-contained true
          -p:PublishSingleFile=true
          -p:EnableCompressionInSingleFile=true
          -p:Version=${{ steps.version.outputs.VERSION }}
          --output ./publish

      - name: Rename binary
        shell: bash
        run: mv ./publish/${{ matrix.binary }} ./publish/${{ matrix.artifact }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ./publish/${{ matrix.artifact }}
          if-no-files-found: error

  create-release:
    name: Create GitHub Release
    needs: build-binaries
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: ./artifacts/*
          generate_release_notes: true

  # Argha - 2026-02-23 - publish NuGet package for dotnet tool install -g dotnet-mcp-server
  publish-nuget:
    name: Publish to NuGet.org
    needs: build-binaries
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # Argha - 2026-02-23 - strip the leading 'v' from the tag to get a clean semver (e.g. v1.0.0 -> 1.0.0)
      - name: Extract version
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Pack
        run: >
          dotnet pack src/McpServer
          --configuration Release
          -p:Version=${{ steps.version.outputs.VERSION }}
          --output ./nupkg

      - name: Push to NuGet.org
        run: >
          dotnet nuget push ./nupkg/*.nupkg
          --api-key ${{ secrets.NUGET_API_KEY }}
          --source https://api.nuget.org/v3/index.json
          --skip-duplicate

  # Argha - 2026-02-24 - publish the dotnet new template package so plugin authors can run
  # "dotnet new install McpServer.Net.Templates" and scaffold plugins in one command.
  # Runs after publish-nuget so McpServer.Plugin.Abstractions is already on NuGet.org when
  # the template package resolves its PackageReference during end-user restore.
  publish-templates:
    name: Publish Templates to NuGet.org
    needs: publish-nuget
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # Argha - 2026-02-24 - strip the leading 'v' from the tag to get a clean semver
      - name: Extract version
        id: version
        shell: bash
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Pack
        run: >
          dotnet pack src/McpServer.Templates
          --configuration Release
          -p:Version=${{ steps.version.outputs.VERSION }}
          --output ./nupkg-templates

      - name: Push to NuGet.org
        run: >
          dotnet nuget push ./nupkg-templates/*.nupkg
          --api-key ${{ secrets.NUGET_API_KEY }}
          --source https://api.nuget.org/v3/index.json
          --skip-duplicate
